<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
           
        <record model="ir.ui.view" id="stock_inventory_location_form_view">
            <field name="name">stock.inventory.location.form</field>
            <field name="model">stock.inventory</field>                
            <field name="inherit_id" ref="stock.view_inventory_form"/>
            <field name="priority" eval="10"/>
            <field name="arch" type="xml">                                                               
                <!-- Add type of inventory : partial or complete. -->                
                <xpath expr="//form[@string='Physical Inventory']/field[@name='date']" position="after">
                    <field name="exhaustive"/>
                </xpath>

                <!-- Add some features like control of location on change... -->
                <xpath expr="/form[@string='Physical Inventory']/notebook/page[@string='General Informations']/field[@name='inventory_line_id']" position="replace">
                    <!-- Add the locations list  for inventory -->                    
                    <field colspan="1" nolabel="1" name="location_ids" domain="[('usage','in',('view', 'internal'))]" attrs="{'invisible':[('exhaustive','!=',True)]}">
                        <tree string="Locations" editable="bottom">                                                                                                       
                            <field name="name"/> 
                        </tree>                                    
                    </field>

                    <!-- Modify the default view to add inventory_id (needed for on_change method call) -->
                    <field colspan="3" name="inventory_line_id" nolabel="1" widget="one2many_list" context="{'inventory_id':active_id}">
                        <tree string="Products" editable="bottom">
                            <field name="inventory_id" invisible="1"/>
                            <field colspan="4" domain="[('usage','=','internal')]" name="location_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" on_change="onchange_location_id(inventory_id, location_id)"/>
                            <field context="location=location_id,uom=product_uom,to_date=parent.date" name="product_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" on_change="on_change_product_id(location_id,product_id,product_uom,parent.date)"  domain="[('type','&lt;&gt;','service')]"/>
                            <field name="product_qty"/>
                            <field name="product_uom"/>
                            <field name="prod_lot_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" />
                            <button name="%(stock.action_view_stock_inventory_line_split)d"
                                string="Split inventory lines" groups="base.group_extended"
                                type="action" icon="terp-stock_effects-object-colorize" states="draft,open,confirm"/>
                            <field name="state" invisible="True"/>
                            <field name = "id" invisible="1"/>
                        </tree>
                        <form string="Products ">
                             <field name="inventory_id" invisible="1"/>
                            <field domain="[('usage','=','internal')]" name="location_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" on_change="onchange_location_id(inventory_id, location_id)"/>
                            <newline/>
                            <field context="location=location_id,uom=product_uom,to_date=parent.date" name="product_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" on_change="on_change_product_id(location_id,product_id,product_uom,parent.date)"  domain="[('type','&lt;&gt;','service')]"/>
                            <field name="product_qty"/>
                            <field name="product_uom"/>
                            <group colspan="2" col="4">
                            <field name="prod_lot_id" attrs="{'readonly': [('id','&lt;&gt;',False)]}" />
                                <button name="%(stock.action_view_stock_inventory_line_split)d"
                                    string="Split inventory lines" groups="base.group_extended"
                                    type="action" icon="terp-stock_effects-object-colorize"/>
                            <field name = "id" invisible="1"/>
                            </group>
                        </form>
                    </field>
                </xpath> 
                
                <!-- Add button to open an inventory. Call wizard on confirm inventory -->
                <xpath expr="//form[@string='Physical Inventory']/group[last()]/button[@name='action_cancel_inventary']" position="replace">                    
                    <button name="action_cancel_inventary" states="draft,open,confirm,done" string="Cancel Inventory" type="object" icon="gtk-cancel"/>                                 
                    <button name="action_open" states="draft" string="Open Inventory" type="object" icon="gtk-open"/>
                </xpath> 
                
                <!-- replace action_confirm button  -->
                <xpath expr="//form[@string='Physical Inventory']/group[last()]/button[@name='action_confirm']" position="replace">                                          
                    <button name="%(action_view_stock_inventory_uninventoried_location)d"
                        string="Confirm Inventory" type="action" states="open" icon="gtk-apply"/>
                </xpath>                                               
            </field>  
        </record>

        <!-- Add filter for complete or partial inventory -->
        <record model="ir.ui.view" id="view_inventory_complete_filter">
            <field name="name">complete.inventory.filter</field>
            <field name="model">stock.inventory</field>
            <field name="type">search</field>
            <field name="inherit_id" ref="stock.view_inventory_filter"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='name']" position="before">
                    <filter icon="terp-check" name="complete_inventories" string="Complete inventories" domain="[('exhaustive', '=', True)]" help="Only select inventories that have no parents." />
                    <separator orientation="vertical"/>
                </xpath>
            </field>
        </record>                

	</data>
</openerp>